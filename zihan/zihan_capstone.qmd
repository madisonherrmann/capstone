---
title: "zihan_capstone"
author: "Zihan Li"
format: revealjs
editor: visual
---

```{r}
#| echo: false
#| message: false
#| warning: false

library(tidyverse)
library(dplyr)
library(kableExtra, exclude = c("group_rows"))
library(cowplot)
devtools::source_url("https://github.com/jjcurtin/lab_support/blob/main/fun_eda.R?raw=true")
devtools::source_url("https://github.com/jjcurtin/lab_support/blob/main/format_path.R?raw=true")
devtools::source_url("https://github.com/jjcurtin/lab_support/blob/main/fun_plots.R?raw=true")
devtools::source_url("https://github.com/jjcurtin/lab_support/blob/main/var_score.R?raw=true")
theme_set(theme_classic())
#update_geom_defaults("bar", list(fill = "steelblue"))
options(dplyr.print_max=Inf)

path_processed <- format_path("studydata/risk2/data_processed/shared")
```
```{r}
#| message: false
#| warning: false

# above the the way to set in quarto
# Read in data
intake <- read_csv(here::here(path_processed, "survey_intake_wide.csv"))
```


## Important demographics

-   Include the age, gender, education, income and living arrangement of the participants.

## Age

```{r}
p_age <- intake |> 
  ggplot(aes(x = age, fill = as.factor(age))) +
  geom_bar(width = 0.9) +
  discrete_scale("fill", scale_name = "personal", palette = grDevices::colorRampPalette(c("#00C0FF", "#000888"))) +
  labs(x = "Age",
       y = "Number of Participants",
       title = "Distribution of Age of the Participants") +
  theme(legend.position="none",
        plot.title = element_text(hjust = 0.5)) 

p_age
```

## Gender

```{r}
p_gender <- intake |> 
  select(gender) |> 
  count(gender) |> 
  mutate(prop = round(n/sum(n), 3),
         lab.ypos = cumsum(prop) - 0.5*prop) |> 
  arrange(desc(n)) |> 
  ggplot(aes(x = "", y = n, fill = gender)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  discrete_scale("fill", scale_name = "personal", palette = grDevices::colorRampPalette(c("#0F9FFF", "#0F9F0F"))) +
  coord_polar("y", start = 0) +
  theme_void() +
  labs(title = "Gender Distribution of the Participants",
       plot.title = element_text(hjust = 0.5))

p_gender
```

## Education

    -   Education mostly lies in the middle level
    -   Better education may be protective, and worse education may have decreased the opportunity to participate?

```{r}
p_edu_bar <- intake |> 
  select(education) |> 
  drop_na(education) |> 
  count(education) |> 
  mutate(prop = round(n/sum(n), 3),
         lab.ypos = cumsum(prop) - 0.5*prop) |> 
  mutate(education = factor(education, levels = c("8th grade or less",
                                                  "Some high school, but did not graduate",
                                                  "High school graduate or GED",
                                                  "Some college or 2-year degree",
                                                  "4-year college graduate",
                                                  "More than 4-year or advanced degree"))) |> 
  ggplot(aes(x = education, y = n, fill = education)) +
  geom_bar(width = 1, stat = "identity", color = "white") +
  discrete_scale("fill", scale_name = "personal", palette = grDevices::colorRampPalette(c("#EE602D", "#887FFF", "#088FFF"))) +
  scale_x_discrete(labels = function(x) str_replace_all(x, " ", "\n")) +
  labs(title = "Distribution of Education Level of the Participants",
       x = "Education Level",
       y = "Number of Participants",
       plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = "none")

p_edu_bar
```


## General Living Arrangement

```{r}
p_liv_arr_1 <- intake |> 
  drop_na(living_arrangement_1) |> 
  select(subid, living_arrangement_1) |> 
  count(living_arrangement_1) |> 
  arrange(desc(n)) |> 
  mutate(living_arrangement_1 = factor(living_arrangement_1,
                                       levels = c("Living with family/others",
                                                  "Recovery community (Sober living/halfway house)",
                                                  "Living alone",
                                                  "Other",
                                                  "Homeless shelter",
                                                  "Homeless unsheltered"))) |> 
  ggplot(aes(x = living_arrangement_1, y = n, fill = n)) +
  scale_x_discrete(labels = function(x) str_replace_all(x, " ", "\n")) +
  geom_bar(stat = "identity") +
  labs(x = "General Living Arrangement",
       y = "Number of Participants",
       title = "Living Arrangement of the Participants") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 0, hjust = 0.4),
        legend.position = "none") 

p_liv_arr_1
```

## Who to live with?

```{r}
# if with others
p_liv_arr_2 <- intake |>
  select(subid, starts_with("living_arrangement_2")) |> 
  select(-contains("text")) |> 
  pivot_longer(starts_with("living_arrangement_2"),
               names_to = "living_arrangement_2",
               values_to = "chosen") |>
  mutate(chosen = factor(chosen, levels = c("no", "yes", NA)),
         living_arrangement_2 = str_replace(living_arrangement_2, "living_arrangement_2_", "")) |>
  group_by(living_arrangement_2) |>
  count(chosen) |> 
  filter(chosen == "yes") |> 
  arrange(desc(n)) |> 
  mutate(living_arrangement_2 = str_replace_all(living_arrangement_2, "_", " "),  
         living_arrangement_2 = str_to_title(living_arrangement_2)) |> 
  mutate(living_arrangement_2 = factor(living_arrangement_2, levels = c("Spouse Sig Other",
                                        "Non Relative",
                                        "Child Grandchild",
                                        "Parent",
                                        "Other Relative"))) |>
  ggplot(aes(x = living_arrangement_2, y = n, fill = n)) +
  geom_bar(stat = "identity") +
  labs(title = "Living Arrangement Distribution of Participants",
       x = "LIving Arrangement",
       y = "Number of Participants") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 0, hjust = 0.4),
        legend.position = "none") 

p_liv_arr_2
```


## Income

```{r}
p_income_bar <- intake |> 
  drop_na(income) |> 
  mutate(income = factor(income,
                         levels = c("Less than $25,000",
                                    "$25,000 - $34, 999",
                                    "$35,000 - $49,999",
                                    "$50,000 - $74, 999",
                                    "$75, 000 - $99, 999",
                                    "$100,000 - $149,999",
                                    "$150, 000 - $199,999",
                                    "$200, 000 or more"))) |> 
  ggplot(aes(x = income, fill = income)) +
  geom_bar(width = 0.9) +
  discrete_scale("fill", scale_name = "personal", palette = grDevices::colorRampPalette(c("#EE6000", "#FFFFFF", "#0080FF"))) +
  labs(x = "Income",
       y = "Number of Participants",
       title = "Distribution of Income of the Participants") +
  theme(legend.position="none",
        plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 20, hjust = 1)) 

p_income_bar
```

## Race

```{r}
p_race <- intake |>
  select(subid, starts_with("race")) |> 
  select(-contains("text")) |> 
  pivot_longer(starts_with("race"),
               names_to = "race",
               values_to = "chosen") |>
  mutate(chosen = factor(chosen, levels = c("no", "yes", NA)),
         race = str_replace(race, "race_", "")) |>
  group_by(race) |>
  count(chosen) |> 
  filter(chosen == "yes") |> 
  arrange(desc(n)) |> 
  mutate(race = str_replace_all(race, "_", " "),  
         race = str_to_title(race)) |> 
  mutate(race = factor(race, levels = c("Asian",
                                        "White",
                                        "Black",
                                        "Hispanic", 
                                        "American Indian Alaska Native",
                                        "Not Listed", 
                                        "Native Hawaiian Other"))) |> 
  ggplot(aes(x = race, y = n, fill = n)) +
  scale_x_discrete(labels = function(x) str_replace_all(x, " ", "\n")) +
  geom_bar(stat = "identity") +
  labs(title = "Race: Participant's Race or Ethnic Origin",
       x = "Race",
       y = "Number of Participants") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 0, hjust = 0.4),
        legend.position = "none") 

p_race
```

## Attitude of the Participants on Abstince

```{r}
p_abstince <- intake |> 
  select(contains(paste0("recovery_",c(1:3),"_"))) |> 
  rename(Satisfaction = recovery_1_satisfaction,
         Motivation = recovery_2_motivation,
         Efficacy = recovery_3_self_efficacy) |> 
  pivot_longer(cols = c("Satisfaction", "Motivation", "Efficacy"),
               names_to = 'Recovery',
               values_to = 'value') |> 
  group_by(Recovery) |> 
  ggplot(aes(x = value, fill = as.factor(value))) +
  geom_bar() +
  discrete_scale("fill", scale_name = "personal", palette = grDevices::colorRampPalette(c("#AACFFF", "#000888"))) +
  facet_wrap(~Recovery, ncol = 2, scales="free_y") +
  ylim(0, 200) +
  labs(x = "Evaluated Scores for Abstince Attitude",
       y = "Number of Participants",
       title = "Distribution of Scores of Abstince Goals") +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5))

p_abstince
```

## Other Subtance to Avoid

```{r}
p_rec_4_1 <- intake |> 
  select(-ends_with("text")) |> 
  select(contains("recovery_4_1")) |> 
  pivot_longer(starts_with("recovery_4_1"),
               names_to = "recovery_4_1",
               values_to = "chosen") |>
  mutate(chosen = factor(chosen, levels = c("no", "yes", NA)),
         recovery_4_1 = str_replace(recovery_4_1, "recovery_4_1_", "")) |>
  group_by(recovery_4_1) |>
  count(chosen) |> 
  filter(chosen == "yes") |> 
  arrange(desc(n)) |> 
  mutate(recovery_4_1 = str_replace_all(recovery_4_1, "_", " "),  
         recovery_4_1 = str_to_title(recovery_4_1)) |> 
  mutate(recovery_4_1 = factor(recovery_4_1, levels = c("Stimulants",
                                                        "Alcohol",
                                                        "Sedatives",
                                                        "Cannabis",
                                                        "Hallucinogens",
                                                        "Inhalants",
                                                        "Tobacco",
                                                        "Ecig",
                                                        "Other"))) |> 
  ggplot(aes(x = recovery_4_1, y = n, fill = n)) +
  scale_x_discrete(labels = function(x) str_replace_all(x, " ", "\n")) +
  geom_bar(stat = "identity") +
  scale_fill_gradient(low = "#FFCCCC", high = "#990000") + 
  labs(title = "Other Substance Participants Intend to Avoid",
       x = "Substance",
       y = "Number of Participants") +
  theme(plot.title = element_text(hjust = 0.5),
        axis.text.x = element_text(angle = 0, hjust = 0.4),
        legend.position = "none") 

p_rec_4_1
```